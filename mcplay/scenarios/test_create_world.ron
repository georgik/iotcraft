// Test Create World MCP Command Scenario
// This scenario tests the fix for the MCP create_world command state transition
Scenario(
    name: "test_create_world",
    description: "Test the MCP create_world command to ensure it properly transitions game state",
    version: "1.0",
    
    // Infrastructure setup - MQTT server for full functionality
    infrastructure: InfrastructureConfig(
        mqtt_server: MqttServerConfig(
            required: true,
            port: 1883,
            config_file: None,
            options: None,
        ),
        mqtt_observer: Some(MqttObserverConfig(
            required: false,
            topics: Some(["mcp/*", "world/*"]),
            client_id: Some("test_observer"),
        )),
        mcp_server: None,
        services: None,
    ),
    
    // Single test client
    clients: [
        ClientConfig(
            id: "test_client",
            player_id: "test_client", 
            mcp_port: 3001,
            client_type: "desktop",
            name: Some("Test Client - MCP Create World"),
            config: None,
        ),
    ],
    
    // Test steps focused on create_world command
    steps: [
        // Step 1: Test the create_world MCP command
        Step(
            name: "test_create_world_command",
            description: "Test create_world MCP command to verify state transition fix",
            client: "test_client",
            action: (
                type: "mcp_call",
                tool: "create_world",
                arguments: {
                    "world_name": "mcp_test_world_fixed",
                    "description": "Test world created to verify state transition fix",
                },
            ),
            wait_before: 3000,   // Wait for client to fully start
            wait_after: 5000,    // Wait to observe state transition
            timeout: 30000,      // 30 second timeout
            success_condition: Some((
                type: "mcp_response",
                expected: "success",
            )),
            depends_on: [],
            timing: None,
            conditions: None,
            expectations: None,
        ),
        
        // Step 2: Verify game state transition by placing a block
        Step(
            name: "verify_ingame_state",
            description: "Verify the client is in InGame state by placing a block",
            client: "test_client",
            action: (
                type: "mcp_call",
                tool: "place_block",
                arguments: {
                    "block_type": "stone",
                    "x": 0,
                    "y": 1,
                    "z": 0,
                },
            ),
            wait_before: 1000,
            wait_after: 2000,
            timeout: 15000,
            success_condition: Some((
                type: "mcp_response",
                expected: "success",
            )),
            depends_on: ["test_create_world_command"],
            timing: None,
            conditions: None,
            expectations: None,
        ),
        
        // Step 3: Check world status to confirm world creation
        Step(
            name: "check_world_status",
            description: "Check world status to confirm the world was created properly",
            client: "test_client",
            action: (
                type: "mcp_call",
                tool: "get_world_status",
                arguments: {},
            ),
            wait_before: 500,
            wait_after: 1000,
            timeout: 10000,
            success_condition: Some((
                type: "mcp_response",
                expected: "success",
            )),
            depends_on: ["verify_ingame_state"],
            timing: None,
            conditions: None,
            expectations: None,
        ),
    ],
    
    // Test configuration
    config: Some(ScenarioConfig(
        timeout_ms: Some(120000),  // 2 minute total timeout
        logging: Some(LoggingConfig(
            level: Some("info"),
            log_mqtt: Some(true),
            log_client_actions: Some(true),
            filters: Some(["world/*", "mcp/*", "ui/*", "create_world", "GameState"]),
        )),
        environment: Some({
            "RUST_LOG": "info,iotcraft_desktop_client=debug",
            "SCENARIO_NAME": "test_create_world",
            "ENABLE_MCP": "true",
        }),
        settings: Some({
            "auto_cleanup": true,
            "preserve_logs": true,
            "fail_fast": true,
        }),
    )),
)
